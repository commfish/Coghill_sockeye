---
title: "Coghill_Sockeye"
author: "Rich Brenner"
date: "June 9, 2017"
output:
  html_document: default
  pdf_document: default
csl: canjfas.csl
bibliography: bibby.bib
---

```{r setup and libraries}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE, 
                      error = FALSE, tidy.opts = list(width.cutoff = 60), 
                      tidy=TRUE)
library(tidyverse)
library(gsl)

options(scipen=999) #disable scientific notation
theme_set(theme_bw(base_size=12)+ 
  theme(panel.grid.major = element_blank(),
  panel.grid.minor = element_blank()))
```

# Purpose
This is a stock (re-)assessment of Coghill Lake sockeye salmon AWC XXX-XXX-XXXX sockeye salmon. The current escapement goal range is 20,000 to 60,000 based upon a Ricker model.

**Import the data**
The field 'Hatch_Pink' are total retuns of hatchery pink salmon to PWS during the year in which most of the corresponding sockeye salmon
would have entered the marine environment. In other words, most sockeye salmon juvenile from brood year 1990 would have emerged from
the gravel during the spring of 1991, spent the summer of 1991 in Coghill Lake and then smolted into the nearshore marine environment
during the spring of 1992. Thus, brood year 1990 sockeye salmon overlap with adult hatchery pink salmon that returned during 1992 (brood year 1990 pink salmon). The brood year 1990 sockeye salmon would also overlap with JUVENILE pink salmon from brood year 1991. However, Ward et al. 2017 did not find that adding a juvenile pink salmon covariate improved model performance.

```{r import data}
Coghill <- read_csv('data/Coghill_Sock.csv') #Use: '../data/ ' to grab 
                                                  #data with knitr, OR just data/ to run from R
glimpse(Coghill)

Coghill %>% 
  mutate(logRS = log(Recruit/Spawn)) %>%  #add log(R/S) to the Coghill dataframe
         mutate(yield = (Recruit - Spawn)) -> Coghill 

summary(Coghill)

#For graphing purposes, create column that states whether lower bound of goal was met: yes or no
```



**A Simple scatter plot**

Let's start with a simple scatter plot of brood year escapements (spawners) and estimated number of recruits from thos spawners. Note that ~10 brood year returns are close to, or lower than, the replacement line: 1988, 1989, 1990, 1991, 1992, 1993, 1994, 2003, 2004, 2006. Otherwise, there is an upward trend of increasing numbers of recruits with more spawners and no obvious attenuation. Historically, some of  the largest yields have come from escapements >80K, but there has also been 2 years in which yields were below the replacement line at these large escapements.

```{r simple scatter plot}
ggplot(data=Coghill, aes(x=Spawn, y=Recruit))+
    geom_point(size=3, color = "black", shape = 16) +
  xlab("Spawners (Brood Yr.)") + 
  ylab("Recruits") +
  # geom_label((aes(label=BroodYr)))+ #geom_text works too.but slightly different.
  geom_smooth(method="gam", formula=y~s(x, k=6), 
              method.args=list(family="quasipoisson", se=TRUE))+
  geom_abline(slope = 1,linetype="dashed", size =1.2) #replacement line

```



**A scatter plot of brood-year spawners vs. log(R/S)**
For some years, relatively high productivity only occurs at low spawner abundance: 1995, 1998, 1999, and 2009. However, for other years, relatively high productivity occurs with higher spawner abundance: 1981, 1982, 1983, 1984, 1985, 1986, 2007, and 2001.
```{r brood vs. spawner}
ggplot(Coghill, aes(x=Spawn, y=logRS))+
    geom_point(size=4, color = "black", shape = 18) +
  xlab("Spawners (Brood Yr.)") + 
  ylab("log(R/S)") +
  geom_label((aes(label=BroodYr)))+ 
  geom_smooth(method="gam", formula=y~s(x, k=6), 
              method.args=list(family="gaussian", se=TRUE))
```



**brood-year spawners vs. yield**
yield is as flat as a pancake across a wide range of escapements....very interesting.
```{r brood_spawn vs. yield}
ggplot(Coghill, aes(x=Spawn, y=yield))+
    geom_point(size=4, color = "black", shape = 18) +
  xlab("Spawners (Brood Yr.)") + 
  ylab("Yield") +
  geom_label((aes(label=BroodYr)))+ 
  geom_smooth(method="gam", formula=y~s(x, k=10), 
              method.args=list(family="gaussian", se=TRUE))

library(mgcv)
fit <- gam(yield~s(Spawn), data=Coghill, gamma=1.4)
summary(fit)
Coghill %>% 
  ggplot(aes(Spawn, yield)) + geom_point() + stat_smooth(method='gam') + xlim(0, 200000)
summary(fit) # check the significance of your smooth term
gam.check(fit) # inspect your residuals to evaluate if the degree of smoothing is good
```


**brood-year vs. yield**
```{r brood_yr vs. yield}
ggplot(Coghill, aes(x=BroodYr, y=yield))+
    geom_point(size=4, color = "black", shape = 18) +
  xlab("Brood Yr.") + 
  ylab("Yield") +
  geom_label((aes(label=BroodYr)))+ 
  geom_smooth(method="gam", formula=y~s(x, k=6), 
              method.args=list(family="gaussian", se=TRUE))
```


**total returns of adult hatchery pink salmon vs. yield**
```{r hatch_pinks vs. yield}
Coghill %>%
  subset(BroodYr>1976) -> Coghill_sub

ggplot(Coghill, aes(x=Hatch_Pinks, y=yield))+
    geom_point(size=4, color = "black", shape = 18) +
  xlab("Hatchery Pink Salmon Return") + 
  ylab("Brood-Year Yield") +
  coord_cartesian(ylim=c(-150000,1300000))+
  geom_label((aes(label=BroodYr)))+ 
   #stat_smooth(method = lm)+
    geom_hline(aes(yintercept=0), size=1.5, show.legend= FALSE)
  #geom_smooth(method="gam", formula=y~s(x, k=10), 
              #method.args=list(family="gaussian", se=TRUE))
```


**total returns of adult hatchery pink salmon vs. productivity**
```{r hatch_pinks vs. productivity}

ggplot(Coghill_sub, aes(x=Hatch_Pinks, y=logRS))+
    geom_point(size=4, color = "black", shape = 18) +
  xlab("Hatchery Pink Salmon") + 
  ylab("log(R/S)") +
  geom_label((aes(label=BroodYr)))+ 
  stat_smooth(method = lm)+
      geom_hline(aes(yintercept=0), size=1.5, show.legend= FALSE)
  #geom_smooth(method="gam", formula=y~s(x, k=10), 
              #method.args=list(family="gaussian", se=TRUE))
```


**Annual Trends**
A quick check for any annual trends in log (R/S): Interesting! The human mind is good at finding patterns that do not necessarily exist, but the GAM fit looks fairly sinusoidal, with a low of log(R/S) at 1985 and peaks at 1977 and 1991. Even if this isn't entirely sinusoidal, it does appear that productiivty is clustered in mulit-year groups, with big breaks between.
```{r annual trends}
ggplot(Coghill, aes(x=BroodYr, y=logRS))+
    geom_point(size=4, color = "black", shape = 18) +
  xlab("Brood Year") + 
  ylab("log(R/S)") +
  geom_label((aes(label=BroodYr)))+ 
  geom_smooth(method="gam", formula=y~s(x, k=10), 
              method.args=list(family="gaussian", se=TRUE))
ggsave("../figures/CoghillSR.png", dpi = 300)
```



**bar plot of escapements**
```{r bar escapements}
ggplot(Coghill, aes(x=BroodYr, y=Spawn, fill = Goal))+
    geom_bar(stat = "identity", show.legend = FALSE) +
  xlab("Brood Year") + 
  ylab("Spawning Escapement")+
  geom_hline(aes(yintercept=20000), colour = "black", size = 1.5, show.legend = FALSE)+
  geom_hline(aes(yintercept=60000), colour = "black", size = 1.5, show.legend= FALSE)
```



**Estimate of *S~msy~* calculated from Lambert's *W***
From this you can see small differences in *S~smy~* calculated using Lambert's *W* (*S~msy~*) vs. Hilborn's approximation (*Hil~msy~*).
Linear regression of r/s vs s with multiplicative error.
```{r linearized Ricker}
rick <- lm(logRS~Spawn, data=Coghill) 
summary(rick)
```



Calculate MSY.
```{r MSY calculation}
a <- coef(rick)[1]  ## 'a' is for calculating S msy, it is in the log space since R/S was changed to log(R/S)
a
alpha <- exp(coef(rick)[1]) ##'alpha' is for prediction of recruits, this takes it from a log space to numbers of fish.
alpha
coef(rick)[2]
b <- -coef(rick)[2]  #Note that it is asking for the negative coeficient of the Ricker Beta function. 
b

1/b  ###1/b should give # of spawners which will yield maximum# of recruits: Smax. 

#Gnu Scientific Library, which contains function for Lambert's W "lambert_w0"
###Lambert's W function as per the Gnu Scientific Library
Smsy <- (1-lambert_W0(exp(1-a)))/b 
Smsy

Hilmsy <- (a*(0.5-0.07*a))/b  ###Hilborn Approximation of Smsy
Hilmsy

# #Bootstrapping CIs.....need to do another way. Realy need to calculate CIs for Smsy and then for the resulting Rmsy
# Smsy_Boot <- bootCase(Hilmsy, B=1000)
```


**Plot the Ricker Curve and estimate of *S~msy~***
Current EG bounds are shown in red. The solid line is the Ricker model curve. The blue dot indicates Smsy as calculated using Lambert's W.
```{r Ricker plot}
msy.r <- alpha * Smsy * exp(-b * Smsy) #recruits at MSY via Lambert's W in numbers of fish (no longer log space)
msy.r
msy.rHil <- alpha*Hilmsy*exp(-b*Hilmsy) #recruits at MSY Hilborn in numbers of fish (no longer log space)
msy.rHil

Coghill %>% 
  mutate(pred = alpha * Spawn * exp(-b * Spawn), #predicted number of recruits at observed numbers of spawners
         msy.s = Smsy,
         msy.r = msy.r,
         msy.rHil = msy.rHil) -> Coghill


###Plot the Ricker function, the replacement line and Smsy
ggplot(Coghill, aes(Spawn, Recruit))+
  geom_point()+
  xlab("# Spawners")+
  ylab("# Recruits")+
  geom_line(aes(Spawn, pred), size=1.2)+ #shows the Ricker curve
  geom_abline(slope=1, lty=4, size =1.1, color=4, show.legend = FALSE)+ #the 1:1 line
  geom_point(aes(Smsy, msy.r), color=4, size=4)+
  annotate("text", x=Smsy, y=msy.r, label="MSY", vjust=-1.2,hjust=-.1, color=4)+ #label 'Lambert' Smsy
  #geom_point(aes(Hilmsy, msy.rHil), color=2, size=2)+
  #annotate("text", x=Hilmsy, y=msy.rHil, label="MSY_Hilborn", vjust=2, hjust=.7, color=2)+ #label Hilborn Smsy
  ylim(0,max(Coghill$Recruit))+
  xlim(0,max(Coghill$Spawn))+
  geom_vline(aes(xintercept=20000, colour="#BB0000"), show.legend = FALSE)+
  geom_vline(aes(xintercept=60000, colour="#BB0000"), show.legend= FALSE)
```




**Investigate autocorrelation and partial autocorrelation**
From the figure below, it appears that escapements are autocorrelated at lag = 1, which
should probably be addressed in subsequent analyses.....maybe I should have started
with this! Note the continuous decline in autocorrelation out to ~lag 8. Very interesting that it 
is such a linear decline.
```{r examine autocorrelation}
acf(x=Coghill$Spawn)

pacf(x=Coghill$Spawn)
```



# Discussion
Given the existence of autocorrelation between years, our results lend support for using an autoregressive Ricker model.
We recommend putting off consideration of a change to this goal until returns from large escapements during the past several years have been realized. Such returns will add much needed contrast to the spawner-recruitment model.




# References
\setlength{\parindent}{-0.2in}
\setlength{\leftskip}{0.2in}
\setlength{\parskip}{8pt}
\noindent

